<!DOCTYPE html>
<html layout:decorate="~{layout/basic.html}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6"
      xmlns:th="http://www.thymeleaf.org">

<head>
    <!-- Title  -->
    <title>Amado - Furniture Ecommerce Template | 주문 </title>

    <!-- Core Style CSS -->
    <!--    <link rel="stylesheet" th:href="@{/css/core-style.css}">-->
    <style>
        .addressDiv {
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .addressDiv h3 {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .addressDiv_DivAddress {
            margin-bottom: 15px;
        }

        .addressDiv_DivAddress label {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .addressDiv_DivAddress_Div {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        /* 상품 정보 테이블 스타일 */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        table th, table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }

        table th {
            background-color: #f2f2f2;
        }

        /* 결제 정보 입력 폼 스타일 */
        #payment_info_area ul {
            list-style: none;
            margin: 0;
            padding: 0;
            margin-bottom: 20px;
        }

        #payment_info_area li {
            margin-bottom: 10px;
        }

        #payment_info_area label {
            margin-right: 10px;
        }

        #btn_pay {
            display: inline-block;
            padding: 10px 20px;
            background-color: #007bff;
            color: #fff;
            text-decoration: none;
            border-radius: 5px;
            font-size: 1.2rem;
            transition: background-color 0.3s ease;
        }

        #btn_pay:hover {
            background-color: #0056b3;
        }

        .payment-options {
            list-style-type: none;
            display: flex;
            padding: 0;
        }

        .payment-option {
            margin-right: 10px;
        }

        .payment-option label {
            border: 1px solid #ccc;
            padding: 10px;
            cursor: pointer;
        }

        #styleDIV {
            margin: 30px 50px; /* 위아래 여백은 30px, 좌우 여백은 20px */
        }
    </style>
</head>

<div layout:fragment="content">

    <div>
        <h1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;주문서</h1>
    </div>
    <div id="styleDIV">
        <div class="addressDiv">
            <h3>배송정보</h3>
            <div class="addressDiv_DivAddress"> <!--배송지-->
                <label for="addressDiv_DivAddress_Div">배송지</label>
                <div id="addressDiv_DivAddress_Div">
                    <!--배송지를 선택하는 라디오버튼+배송지별칭 출력되는 부분-->
                </div>
            </div>
            <div class="addressDiv_DivAddress"> <!--이름 / 연락처-->
                <label for="addressNamePhone">이름 / 연락처</label>
                <span id="addressNamePhone">[배송지 변경]을 클릭하여 배송지를 등록해주세요.</span>
            </div>
            <div class="addressDiv_DivAddress"> <!--주소-->
                <label for="address">주소</label>
                <span id="address">[배송지 변경]을 클릭하여 배송지를 등록해주세요.</span>
            </div>
            <div class="addressDiv_DivAddress"> <!--배송요청사항-->
                <div style="display: flex; align-items: center;">
                    <label>배송 요청사항</label>
                    <select id="options" name="a_request"
                            style="width: calc(100% - 100px); padding: 10px; margin-bottom: 15px; border-radius: 5px; border: 1px solid #ccc; background-color: #fff; font-size: 16px; color: #333;">
                        <option value="선택안함">배송 시 요청사항을 선택해주세요</option>
                        <option value="부재 시 경비실에 맡겨주세요">부재 시 경비실에 맡겨주세요</option>
                        <option value="부재 시 택배함에 넣어주세요">부재 시 택배함에 넣어주세요</option>
                        <option value="부재 시 집 앞에 놔주세요">부재 시 집 앞에 놔주세요</option>
                        <option value="배송 전 연락 바랍니다">배송 전 연락 바랍니다</option>
                        <option value="파손의 위험이 있는 상품입니다. 배송 시 주의해 주세요">파손의 위험이 있는 상품입니다. 배송 시 주의해 주세요</option>
                        <option value="직접 입력">직접 입력</option>
                    </select>
                </div>
                <div id="customInput" style="display: none;">
                    <input id="customRequest" name="a_customRequest" placeholder="직접 입력" type="text">
                </div>
            </div>
        </div>
        <div>
            <h3>상품정보</h3>
            <table>
                <thead>
                <tr>
                    <th scope="col">상품 정보</th>
                    <th scope="col">수량</th>
                    <th scope="col">적립금</th>
                    <th scope="col">주문금액</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td>
                        <div>
                            <div> <!--alt 이미지가 출력되지 않을 때-->
                                <img alt="꼼파뇨 DTP 해피 데이 반팔티 화이트"
                                     src="//image.msscdn.net/images/goods_img/20240312/3943019/3943019_17108267959953_62.jpg">
                                <input class="ino" type="hidden" value="1">
                            </div>
                            <div>
                                <div>
                                    <strong>
                                        <span>[꼼파뇨]</span>
                                    </strong>
                                    <span>
                                <a href="/app/goods/3943019/0">DTP 해피 데이 반팔티 화이트</a>
                            </span>
                                </div>
                                <div>
                                    색상 : <span id="color">color</span>
                                </div>
                                <div style="display: inline;">
                                    사이즈 : <span id="size">size</span>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td><strong id="count">1</strong>개</td>
                    <td>358 원</td>
                    <td>
                        <del>50,000 원</del>
                        <strong>32,500 원</strong>
                    </td>
                </tr>
                </tbody>
            </table>

            <div style="display: flex;">
                <div style="margin-right: 0px;">
                    <table>
                        <tr>
                            <td>상품 금액</td>
                            <td><strong>227,000 원</strong></td>
                        </tr>
                        <tr>
                            <td>적립금 선할인</td>
                            <td>
                                <input id="pointFirstUse" type="checkbox" value="1743">
                                <strong>1,743 원</strong>
                                <strong>적립</strong>
                                <span>(적립금 선할인 가능 금액은 1,743원입니다.)</span>
                            </td>
                        </tr>
                        <tr>
                            <td>적립금 사용</td>
                            <td id="pointUse">
                                5,000원 이상 보유 시 사용 가능합니다. (총 보유 적립금 <strong
                                    th:value="${memberPoint}">[[${memberPoint}]]</strong>원)
                            </td>
                        </tr>
                        <tr>
                            <td>배송비</td>
                            <td><strong>배송비 무료</strong></td>
                        </tr>
                    </table>
                </div>
                <div>
                    <table>
                        <tr>
                            <td>할인 합계</td>
                            <td>
                                - <strong>71,670</strong> 원
                                <span>32</span>
                                <span>%</span>
                            </td>
                        </tr>
                        <tr>
                            <td>최종 결제 금액</td>
                            <td><strong>153,587</strong> 원</td>
                        </tr>
                        <tr>
                            <td>총 적립금</td>
                            <td><span>0</span> 원</td>
                        </tr>
                        <tr>
                            <td colspan="2">
                                · 적립금 사용 시 총 상품 금액의 7% 이내로 제한됩니다. 일부 상품은 적립금 사용이 불가합니다. <a
                                    href="/app/cs/faq/005/005000">[적립금
                                관련 FAQ]</a>
                                <br>. 적립금 선할인 선택 시 예상 적립금만큼의 결제금액이 차감됩니다.
                            </td>
                        </tr>
                    </table>
                </div>
            </div>

            <div>
                <h3>결제 정보</h3>
                <div>
                    <div>
                        <div id="payment_info_area">
                            <!--결제 정보-->
                            <ul>
                                <li>결제 수단</li>
                                <li>
                                    <ul class="payment-options">
                                        <li class="payment-option" id="payment_choice_toss">
                                            <input id="payment_btn2" name="paymentMethod" type="radio" value="toss">
                                            <label for="payment_btn2">
                                                토스페이
                                            </label>
                                        </li>
                                        <li class="payment-option" id="payment_choice_kakaopay">
                                            <input checked id="payment_btn3" name="paymentMethod" type="radio"
                                                   value="kakaopay">
                                            <label for="payment_btn3">
                                                카카오페이
                                            </label>
                                        </li>
                                        <li class="payment-option" id="payment_choice_payco">
                                            <input id="payment_btn4" name="paymentMethod" type="radio" value="payco">
                                            <label for="payment_btn4">
                                                페이코
                                            </label>
                                        </li>
                                        <li class="payment-option" id="payment_choice_pg">
                                            <input id="payment_btn1" name="paymentMethod" type="radio" value="pg">
                                            <label for="payment_btn1">
                                                일반결제
                                            </label>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                            <div style="display: none;"> <!--style="display: block;"-->
                                <ul>
                                    <li>일반 결제</li>
                                    <li>
                                        <div>
                                            <div id="box-payKind-info-CARD">
                                                <div>
                                                    <select id="card_code" name="card_code">
                                                        <option value="">카드 선택</option>
                                                        <option value="CCKM">KB카드</option>
                                                        <option value="CCLG">신한카드</option>
                                                        <option value="CCDI">현대카드</option>
                                                        <option value="CCSS">삼성카드</option>
                                                        <option value="CCNH">농협카드</option>
                                                        <option value="CC92">카카오뱅크</option>
                                                        <option value="CCBC">BC카드</option>
                                                        <option value="CCHN">하나카드</option>
                                                        <option value="CC33">우리카드</option>
                                                        <option value="CCLO">롯데카드</option>
                                                        <option value="CCCT">씨티카드</option>
                                                        <option value="CC204">새마을금고</option>
                                                        <option value="CC302">케이뱅크</option>
                                                        <option value="CCKJ">광주은행</option>
                                                        <option value="CC207">우체국</option>
                                                        <option value="CCJB">전북은행</option>
                                                        <option value="CCSU">수협은행</option>
                                                        <option value="CC48">신협은행</option>
                                                    </select>
                                                    <select id="card_quota" name="select-card_quota">
                                                        <option value="1">일시불</option>
                                                        <option value="2">2개월 (무이자)</option>
                                                        <option value="3">3개월 (무이자)</option>
                                                        <option value="4">4개월</option>
                                                        <option value="5">5개월</option>
                                                        <option value="6">6개월</option>
                                                        <option value="7">7개월</option>
                                                        <option value="8">8개월</option>
                                                        <option value="9">9개월</option>
                                                        <option value="10">10개월</option>
                                                        <option value="11">11개월</option>
                                                        <option value="12">12개월</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                            <ul id="soldOutNonRefundablePayment" style="display: table;">
                                <li>품절 시 환불 안내</li>
                                <li>
                                    <span>결제하신 수단으로 취소됩니다.</span>
                                    <div>
                                        <ul>
                                            <li>· 입점업체 배송은 낮은 확률로 상품이 품절일 가능성이 있습니다. 이에 품절 시 빠르게 환불 처리해드립니다.</li>
                                            <li>· 현금 환불의 경우, 예금정보가 일치해야 환불 처리가 가능합니다. 은행명, 계좌번호, 예금주명을 정확히 기재 부탁드립니다.
                                            </li>
                                            <li>· 환불 받으신 날짜 기준으로 3~5일(주말 제외) 후 결제대행사에서 직접 고객님의 계좌로 환불 처리됩니다.</li>
                                        </ul>
                                    </div>
                                </li>
                            </ul>
                            <!-- 주문자 동의 -->
                            <ul>
                                <li>주문자 동의</li>
                                <li>
                                    <div>
                                        <div>
                                            주문 내용을 확인했으며 서비스 약관 및 결제에 동의합니다.
                                        </div>
                                        <!-- 비회원만 존재 -->
                                        <!-- // 비회원만 존재 -->
                                        <div>
                                            <!--메모장에서 추가하기-->
                                        </div>
                                    </div>
                                </li>
                            </ul>
                            <!-- // 주문자 동의 -->
                        </div>
                    </div>
                    <!--//결제 정보-->
                    <!--//신용카드 -->
                </div>
                <div>
                    <a id="btn_pay">
                        <span id="btn-pay_amt" style="font-size:20px;">153587</span>원 결제하기&nbsp;
                    </a>
                </div>
            </div>
        </div>
    </div>


        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script> <!--axios 사용-->
        <script th:src="@{/js/address.js}"></script>
        <script th:src="@{/js/pay.js}"></script>
        <script th:inline="javascript">
            // 페이지 로드 시 첫번째 라디오 버튼의 클릭 이벤트를 발생시키는 함수
            function triggerFirstRadioButtonClick() {
                let radio = $('#addressDiv_DivAddress_Div input[type="radio"]').first();
                if (radio.length > 0) {
                    radio.click(); // 첫 번째 라디오 버튼 클릭 이벤트 수동으로 발생시킨다.
                }
            }

            function addressModifyBtnClick() {
                window.open('/orders/address/list', '배송지 선택', 'width=600,height=700,left=350,top=' + (screen.height - 1000) / 2);
                // 새 창으로 신규 배송지 추가 창을 띄운다.(top - 값이 높아질수록 위로)
            }

            function getResultFromUrl() {
                const urlParams = new URLSearchParams(window.location.search);
                const resultParam = urlParams.get('result');
                // json으로 변경하지 않으면 object:object로 출력됨
                // url에는 인코딩되어 전달된다.
                // result 파라미터로 전달된 값이 있으면 디코딩된 데이터 리턴, 없으면 null 리턴
                return resultParam ? JSON.parse(decodeURIComponent(resultParam)) : null;
            }

            function getPaymentMethodCheckedRadioButton() {
                // 라디오 버튼들을 가져옴(결제수단 선택)
                let radios = document.getElementsByName('paymentMethod');

                // 라디오 버튼들을 돌면서 선택된 라디오 버튼 값(결제수단)을 가져온다.
                // toss, kakaopay, payco, pg
                for (var i = 0; i < radios.length; i++) {
                    if (radios[i].checked) {
                        // 선택된 라디오 버튼의 값(결제수단)를 리턴
                        return radios[i].value;
                    }
                }
                return null;
            }

            function getAddressCheckedRadioButton() {
                // 라디오 버튼들을 가져옴(배송지 선택)
                let radios = document.getElementsByName('option');

                // 라디오 버튼들을 돌면서 선택된 라디오 버튼 값(ano)을 가져온다.
                for (var i = 0; i < radios.length; i++) {
                    if (radios[i].checked) {
                        // 선택된 라디오 버튼의 값(ano)를 리턴
                        return radios[i].value;
                    }
                }
                return null;
            }

            $(document).ready(function () {
                // point가 5000원 이상일때부터 포인트 사용 가능
                debugger
                const point = [[${memberPoint}]];
                let pointUseTD = $('#pointUse') // td
                if (point >= 5000) {
                    pointUseTD.text(`(총 보유 적립금 ${point}원)`);
                    let pointUseInput = $('<input>', {
                        type: 'text',
                        id: 'pointUseInput',
                        name: 'o_pointUse',
                        placeholder: '사용할 포인트 입력'
                    });
                    // pointUseInput.placeholder = '사용할 포인트를 입력해주세요.';
                    pointUseTD.append(pointUseInput);
                }
                // 포인트 사용 input 태그의 입력을 감지한다.
                $('#pointUseInput').on('input', function () {
                    // 숫자만 입력할 수 있도록 한다.(숫자 외 다른 글자 입력 시 지워짐)
                    let inputValue = $(this).val().replace(/[^0-9]/g, '');
                    $(this).val(inputValue);
                    if ($(this).val() > point) {
                        alert('사용 포인트가 회원님이 보유하신 포인트보다 많습니다.')
                        $(this).val('')
                    }
                });

                // URL에서 result 매개변수 값을 가져오는 함수
                // list.html에서 파라미터에 result로 배송지 선택값을 보낸다.
                debugger
                const addressDiv = document.querySelector('.addressDiv') // 배송정보 div
                // restController로 회원의 배송지목록을 불러온다.
                addressList().then(result => {
                    debugger
                    let array = Math.min(3, result.addressDTOS.length); //둘중에 작은값 반환(최대 3번)
                    for (let i = 0; i < array; i++) {
                        let address = result.addressDTOS[i];

                        // 선택 버튼 생성
                        let radioButton = $('<input>', {
                            type: 'radio',
                            id: 'address' + (i + 1),
                            name: 'option',
                            value: address.a_no // 배송지번호
                        });
                        // 라벨 생성
                        let label = $('<label>', {
                            for: 'address' + (i + 1),
                            text: address.a_nickName // 배송지별칭
                        });

                        // 라디오 버튼과 라벨을 부모 요소인 div 태그에 추가
                        $('#addressDiv_DivAddress_Div').append(radioButton, label);
                    }
                    // 배송지 선택 라디오 버튼을 모두 출력 후 배송지 변경 버튼 생성
                    let addressUpdateBtn = $('<button>', {
                        type: 'button',
                        text: '배송지 변경',
                        click: function () {
                            addressModifyBtnClick(); // 배송지 목록 창을 띄운다.
                        }
                    });
                    $('#addressDiv_DivAddress_Div').append(addressUpdateBtn);

                    // 라디오 버튼 클릭 이벤트 설정
                    let radio = $('#addressDiv_DivAddress_Div input[type="radio"]');
                    radio.on('click', function () {
                        debugger
                        let ano = $(this).val(); // 클릭한(this)배송지번호
                        readOneAddress(ano).then(addressDTO => {
                            printAddress(addressDTO);
                        })
                    })

                    // 배송지리스트에서 result 객체 가져와 출력하기
                    let address = getResultFromUrl();
                    debugger
                    console.log(address); // 가져온 결과 출력
                    if (address !== null) { // 선택된 값이 있으면
                        let selectedInput = $('#address1'); // 첫번째 배송지의 input 태그
                        let selectedLabel = $('label[for="address1"]'); // 첫번째 배송지의 label 태그
                        selectedInput.val(address.a_no);
                        selectedLabel.text(address.a_nickName);
                    }

                    // 페이지 로드 시 첫 번째 라디오 버튼을 강제로 클릭하여 배송지 정보를 띄울 수 있도록 함
                    // 위의 클릭 이벤트를 설정한 뒤에 클릭해야 실행된다 ..
                    triggerFirstRadioButtonClick();

                }).catch(e => {
                    alert("addressList Exception...");
                })

                // 라디오 버튼을 클릭하여 선택한 배송지의 정보를 출력
                function printAddress(address) {
                    addressDiv.querySelector("#addressNamePhone").textContent = `${address.a_recipient}, ${address.a_phone}`;
                    addressDiv.querySelector("#address").textContent = `(${address.a_zipCode}) ${address.a_address} ${address.a_detail}`;

                    const selectElement = addressDiv.querySelector("#options");

                    // 각 option 요소를 확인하고, 값을 비교하여 기본 선택값 설정
                    for (let i = 0; i < selectElement.options.length; i++) {
                        const option = selectElement.options[i];
                        if (option.value === address.a_request) {
                            option.selected = true;
                            if (i == 6) { // '직접 입력' 일 때 실행
                                $('#customInput').show();
                                $('#customRequest').prop('disabled', false);
                                // 필드 활성화
                                $("#customRequest").attr("required", true);
                                // 직접 입력 옵션 선택 시 보여주는 input 태그에 필수 입력 속성을 부여한다.
                                $("#customRequest").val(address.a_customRequest);
                                // 기본배송지의 customRequest 값을 넣어준다
                            } else { // '직접 입력'이 아니면
                                $('#customInput').hide();
                                $('#customRequest').val(''); // 값을 지운다.
                                $('#customRequest').prop('disabled', true);
                                // 필드 비활성화(직접 입력 외 다른 값을 선택하면 custonRequest에는 null이 들어감
                            }
                            break;
                        }
                    }
                }

                $('#options').change(function () {
                    debugger;
                    // 직접 입력 옵션 선택 시 input 태그를 가지고 있는 div를 표시
                    if ($(this).val() === '직접 입력') {
                        $('#customInput').show();
                        $('#customRequest').prop('disabled', false);
                        // 필드 활성화
                        $("#customRequest").attr("required", true);
                        // 직접 입력 옵션 선택 시 보여주는 input 태그에 필수 입력 속성을 부여한다.
                    } else {
                        $('#customInput').hide();
                        $('#customRequest').prop('disabled', true);
                        // 필드 비활성화(직접 입력 외 다른 값을 선택하면 custonRequest에는 null이 들어감
                    }
                });

                $('#btn_pay').on('click', function () {
                    // 카카오페이 선택 후 결제하기 버튼 클릭 시
                    debugger
                    let ano = getAddressCheckedRadioButton(); // 배송지 변호
                    let o_state = '주문접수'
                    let price = $('#btn-pay_amt').text(); // 총 결제금액
                    let pointFirstUseCheckBox = $('#pointFirstUse'); // 적립금 선할인 체크박스
                    let pointFirstUse = 0;
                    if (pointFirstUseCheckBox.prop('checked')) { // 적립금 선할인을 체크했다면
                        pointFirstUse = pointFirstUseCheckBox.val(); // 적립금 선할인 값 저장
                    }
                    let pointUse = $('#pointUseInput').val(); // 적립금 사용금액
                    let paymentMethod = getPaymentMethodCheckedRadioButton(); // 결제수단
                    let inos = []; // 선택한 상품의 번호들
                    $('.ino').each(function () {
                        inos.push($(this).val());
                    });
                    let counts = []; // 상품 구매 수량들
                    $('#count').each(function () {
                        counts.push($(this).text());
                    });
                    let sizes = []; // 상품 사이즈들
                    $('#size').each(function () {
                        sizes.push($(this).text());
                    });
                    let colors = []; // 상품 색상들
                    $('#color').each(function () {
                        colors.push($(this).text());
                    });

                    console.log("ano : " + ano);
                    console.log("price : " + price);
                    console.log("pointFirstUse : " + pointFirstUse);
                    console.log("pointUse : " + pointUse);
                    console.log("paymentMethod : " + paymentMethod);
                    console.log("inos : " + inos);
                    console.log("counts : " + counts);
                    console.log("sizes: " + sizes);
                    console.log("colors : " + colors);

                    let ordersObj = {
                        ano: ano,
                        o_state: o_state,
                        totalPrice: price,
                        pointFirstUse: pointFirstUse,
                        pointUse: pointUse,
                        paymentMethod: paymentMethod,
                        inos: inos,
                        counts: counts,
                        sizes: sizes,
                        colors: colors
                    }
                    console.log(ordersObj);

                    kakaoPayReady(ordersObj).then(result => {
                        debugger
                        // '_self' : 현재 창에서 오픈
                        window.open(result.next_redirect_pc_url, '_self');
                    })
                })


            });
        </script>
    </div>
</div>

<!--layout:fragment="script" 삭제 후 content 안으로 옮김-->
<!--: 이것은 서버 측에서 실행되어야 하는 스크립트를 지정하는 코드이며, HTML 파일이 서버에서 렌더링될 때만 실행된다.-->
<!--$(document).ready(function () { ... }); : 스크립트 코드는 서버 측에서 실행되는게 아니라 클라이언트 측에서 실행되어야 한다.-->